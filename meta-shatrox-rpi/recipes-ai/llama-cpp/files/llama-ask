#!/bin/bash
################################################################################
# llama-ask - Voice-interactive AI assistant for Raspberry Pi
# Uses llama-server HTTP API with Qwen chat template for accurate responses
################################################################################

MODEL_DIR="/usr/share/llama-models"
DEFAULT_MODEL="$MODEL_DIR/default"
SILENT_MODE=0
SERVER_URL="http://127.0.0.1:8080"

# Check for --silent flag
if [ "$1" = "--silent" ]; then
    SILENT_MODE=1
    shift
fi

# Check if prompt provided
if [ $# -eq 0 ]; then
    echo "Usage: llama-ask [--silent] \"Your question here\""
    echo "Example: llama-ask \"What is Raspberry Pi?\""
    echo ""
    echo "The AI will respond with text and voice."
    echo "Use --silent to disable voice output."
    exit 1
fi

# Combine all arguments as prompt
USER_PROMPT="$*"

echo "ü§ñ Asking AI: $USER_PROMPT"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Check if llama-server is running
if ! curl -s "$SERVER_URL/health" >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  llama-server is not running."
    echo "   Start it with: systemctl start llama-server"
    exit 1
fi

# Format prompt with Qwen chat template
CHAT_PROMPT="<|im_start|>system
You are a helpful assistant.<|im_end|>
<|im_start|>user
$USER_PROMPT<|im_end|>
<|im_start|>assistant
"

# Call API and parse response with Python
RESPONSE=$(curl -s "$SERVER_URL/completion" \
    -H "Content-Type: application/json" \
    -d "{
        \"prompt\": $(echo "$CHAT_PROMPT" | python3 -c 'import sys,json; print(json.dumps(sys.stdin.read()))'),
        \"n_predict\": 200,
        \"temperature\": 0.7,
        \"top_p\": 0.9,
        \"top_k\": 40,
        \"stop\": [\"<|im_end|>\"],
        \"stream\": false
    }" | python3 -c "
import sys, json, re

try:
    data = json.load(sys.stdin)
    content = data.get('content', '')
    
    # Trim incomplete final sentence (ends without proper punctuation)
    sentences = re.split(r'([.!?]\s+)', content)
    if len(sentences) > 1 and sentences[-1].strip() and not sentences[-1].strip().endswith(('.', '!', '?')):
        content = ''.join(sentences[:-1])
    
    print(content.strip())
except Exception as e:
    print(f'Error parsing response: {e}', file=sys.stderr)
    sys.exit(1)
")

# Check if response is empty
if [ -z "$RESPONSE" ]; then
    echo "Error: No response from AI"
    exit 1
fi

# Display response
echo "$RESPONSE"
echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# Speak the response if not in silent mode
if [ $SILENT_MODE -eq 0 ]; then
    if command -v speak >/dev/null 2>&1; then
        echo ""
        echo "üîä Speaking response..."
        speak "$RESPONSE"
    else
        echo "Warning: 'speak' command not found, skipping voice output"
    fi
fi

exit 0
