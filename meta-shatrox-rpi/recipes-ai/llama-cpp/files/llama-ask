#!/bin/bash
################################################################################
# llama-ask - Voice-interactive AI assistant for Raspberry Pi
# Uses llama-server HTTP API for fast responses
################################################################################

MODEL_DIR="/usr/share/llama-models"
DEFAULT_MODEL="$MODEL_DIR/default"
SILENT_MODE=0
SERVER_URL="http://127.0.0.1:8080"

# Check for --silent flag
if [ "$1" = "--silent" ]; then
    SILENT_MODE=1
    shift
fi

# Check if prompt provided
if [ $# -eq 0 ]; then
    echo "Usage: llama-ask [--silent] \"Your question here\""
    echo "Example: llama-ask \"What is Raspberry Pi?\""
    echo ""
    echo "The AI will respond with text and voice."
    echo "Use --silent to disable voice output."
    exit 1
fi

# Combine all arguments as prompt
PROMPT="$*"

echo "ðŸ¤– Asking AI: $PROMPT"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check if llama-server is running
if ! curl -s "$SERVER_URL/health" >/dev/null 2>&1; then
    echo "âš ï¸  llama-server is not running. Starting server..."
    echo "   This may take a few seconds..."
    
    # Fallback to direct llama-cli if server not available
    RESPONSE=$(echo "$PROMPT" | /usr/bin/llama-cli \
        -m "$DEFAULT_MODEL" \
        --n-predict 256 \
        --temp 0.7 \
        --top-k 40 \
        --top-p 0.9 \
        --threads 4 \
        2>/dev/null | \
        grep "^>" | \
        grep -v "EOF by user" | \
        sed 's/^> //')
else
    # Use HTTP API for fast response
    # Use awk to properly extract JSON content field (handles escaped quotes)
    RESPONSE=$(curl -s "$SERVER_URL/completion" \
        -H "Content-Type: application/json" \
        -d "{
            \"prompt\": \"$PROMPT\",
            \"n_predict\": 80,
            \"temperature\": 0.7,
            \"top_k\": 40,
            \"top_p\": 0.9,
            \"stream\": false
        }" | awk -F'"content":"' '{print $2}' | awk -F'","' '{print $1}' | sed 's/\\n/\n/g; s/\\"/"/g; s/\\\\/\\/g')
fi

if [ -z "$RESPONSE" ]; then
    echo "Error: No response from AI"
    exit 1
fi

echo "$RESPONSE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Speak the response if not in silent mode
if [ $SILENT_MODE -eq 0 ]; then
    if command -v speak >/dev/null 2>&1; then
        echo ""
        echo "ðŸ”Š Speaking response..."
        speak "$RESPONSE"
    else
        echo "Warning: 'speak' command not found, skipping voice output"
    fi
fi

exit 0
